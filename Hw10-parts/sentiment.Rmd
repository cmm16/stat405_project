---
title: "Sentiment"
author: "Henry Creamer"
date: "November 15, 2019"
output: pdf_document
---

1. Decide what to do with rows that do not have an overall rating (3925 rows); we could assign a neutral score (like 5) or we could drop the rows?
  -We could  use the rows that don't have overall rating as test data. So we use our sentiment analysis model to assign scores to these rows, then we look at "recommended" column for these test scores and see if we classified correctly (i.e. airports that were recommended, we check to see if we gave it a good overall_rating)
2. Compress reviews using our top2kdf
3. Run sentiment analysis on each compressed review (get back positive or negative or neutral)
4. Determine whether the review matches the overall rating
5. come up with a plot...

```{r, echo=TRUE}
options(java.parameters = "- Xmx1024m")
gc()
library(RSentiment)
library(stringr)
reviews <- read.csv("airport.csv")
reviews <- reviews[!is.na(reviews$overall_rating), ]
topWords <- read.csv("top2kdf.csv")
```

Condenses our airport review data by replacing words with a synonym word that occurs a lot. We targeted words that showed up a lot in the airport reviews. This will allow us to run sentiment analysis more effectively.
```{r, echo=TRUE}
goodWordsToCondense <- c("good", "bad", "flight", "airplane", "experience", "very", "clean", "move", "bar", "advance", "close", "break", "place", "charge", "drive", "area", "avenue", "full", "fair", "force", "action", "all", "capacity", "character", "go", "great", "individual", "line", "over", "passage", "access", "amount")

for (goodWord in goodWordsToCondense) {
  wordsToReplace <- topWords[topWords$X2 == goodWord | topWords$X3 == goodWord | topWords$X4 == goodWord | topWords$X5 == goodWord | topWords$X6 == goodWord | topWords$X7 == goodWord | topWords$X8 == goodWord | topWords$X9 == goodWord | topWords$X10 == goodWord | topWords$X11 == goodWord, ][2]
  wordsToReplace <- as.vector(wordsToReplace[!is.na(wordsToReplace)])
  for (word in wordsToReplace) {
    reviews$condensedContent <- sapply(reviews$content, str_replace_all, pattern = word, replacement = goodWord)
  }
}
```

Runs sentiment analysis on the airport review. A positive score means it has a positive sentiment, a 0 score means neutral sentiment, and a negative score means it has a negative sentiment.
```{r, echo=TRUE}
#Vectorized version
all_sentiment <- sapply(reviews$content, calculate_score,)

#Due to memory issues with JVM in the RSentiment package, may have to run the  below version. This version garbage collects so no memory errors occur
all_sentiment <- c()

for (i in 1:length(reviews$content)) {
  print(i)
  all_sentiment <- c(calculate_score(reviews$content[i])[1], all_sentiment)
  if (i %% 50 == 0) {
    gc()
  }
}

```

Update the dataframe and save it. This will allow us to avoid running the code again.
```{r, echo=TRUE}
reviews$sentiment <- all_sentiment
write.csv(reviews, "sentimentAirport.csv")
```

Code for comparing to overall rating
```{r, echo=TRUE}
reviews <- read.csv("sentimentAirport.csv")
reviews$sentiment
```

Clip sentiment values and assign to new column
```{r, echo=TRUE, message = FALSE, warning = FALSE}
library(ramify)
clipped_vals <- clip(reviews$sentiment, -1, 1)
reviews$clipped_sentiment <- clipped_vals
```

Check to see if our sentiment matches the overall rating
```{r, echo=TRUE, message = FALSE, warning = FALSE}
reviews$match <- ifelse(( reviews$clipped_sentiment < 0 & reviews$overall_rating < 4) | ( reviews$clipped_sentiment > 0 & reviews$overall_rating > 7 ) | ( reviews$clipped_sentiment==0 & reviews$overall_rating >=4 & reviews$overall_rating <=7), 1, 0)
head(reviews$match)
```

Calculate percentage of correct matches we made across indivdual reviews
```{r, echo=TRUE, message = FALSE, warning = FALSE}
percentage_correct <- sum(reviews$match / length(reviews$match))
percentage_correct
```

Create a pie chart showing the accuracy
```{r, echo=TRUE, message = FALSE, warning = FALSE}
slices <- c(percentage_correct, 1-percentage_correct)
lbls <- c(paste("Number of Correct Matches\n", round(percentage_correct * 100,4),"%"), paste("Number of Incorrect Matches\n", round(((1-percentage_correct)*100),4),"%"))
pie(slices, labels = lbls, main="Matching Sentiment of Individual Airport Reviews to Overall Ratings", col = c("darkgreen", "red"))
```


Group by airport..
```{r, echo=TRUE, message = FALSE, warning = FALSE}
dcon <- dbConnect(SQLite(), dbname = "group10.db")
dbListTables(dcon)

dbWriteTable(dcon, "SentimentTable", reviews)
dbListFields(dcon, "SentimentTable")

res <- dbSendQuery(conn = dcon, "
SELECT airport_name as Airport, sum(match) as NumMatches, count(match) as TotalReviews
FROM SentimentTable
GROUP BY title;")
matches_by_airport <- dbFetch(res, -1)
dbClearResult(res)
```

Plot the Accuracy by Airport for all major Texas airports
```{r, echo=TRUE, message = FALSE, warning = FALSE}
texas_airports <- matches_by_airport[matches_by_airport$Airport == "austin-airport" | matches_by_airport$Airport == "dallas-fort-worth-airport" | matches_by_airport$Airport == "dallas-love-field-airport" | matches_by_airport$Airport == "houston-george-bush-intercontinental-airport" | matches_by_airport$Airport == "houston-hobby-airport" | matches_by_airport$Airport == "el-paso-airport" ,]

value <- texas_airports$TotalReviews

ggplot(data = texas_airports, aes(x=c("A", "A","A","A","A","A"), fill = )) + 
  geom_bar(stat="identity", fill="orange") + 
  labs(x="Word", y="Count", title="Top 25 word counts") +
  theme(axis.text.x=element_text(angle=90, hjust=1, size=12))
```

https://www.r-graph-gallery.com/48-grouped-barplot-with-ggplot2.html

```{r echo =TRUE}

airport <- c(rep("AUS", texas_airports[1,3]), rep("DFW", texas_airports[2,3]), rep("DAL", texas_airports[3,3]),
             rep("ELP", texas_airports[4,3]), rep("IAH", texas_airports[5,3]), rep("HOU", texas_airports[6,3]))
result <- c(rep("success",5), rep("failure",3), rep("success",9), rep("failure",40),
            rep("failure",3), rep("success",1), rep("failure",2), rep("success",28), rep("failure",69),
            rep("success",2), rep("failure",2))
data <- data.frame(airport,result)

ggplot(data, aes(fill=result, x=airport)) + 
  geom_bar(position="fill") + 
  xlab("Texas Airports") + 
  ylab("Number of Reviews") + 
  ggtitle("Percentage")

```



