---
title: "Group 10"
author: "Henry Creamer, Melinda Ding, Aaryan Jadhav, Cole Morgan, Caleigh Page"
date: "December 6, 2019"
output: ioslides_presentation
runtime: shiny

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}
library(RSQLite)
library(ggplot2)
library(tidyverse)
library(grid)
library(gridBase)
library(gridExtra)
library(shiny)
library(dplyr)
dcon <- dbConnect(SQLite(), dbname = "C:/Users/bcard/Documents/SavedStuff/Stat405/group10.db")
```


## Introduction 

RESEARCH QUESTIONS

- What are the most popular airlines and destinations from IAH? 
- How have flight patterns out of IAH changed over time? 
- How does airport quality affect the number of flights and passengers going to an airport?

METHODOLOGY 

- Gathered and cleaned data from 5 different data sources
- Explored the data 
- Created two killer plots to summarize findings


## Data Set #1 
FLIGHT DATA 

- Have years 2018, 2017, 2016, and 2015 (4 million+ rows of data)
- Source: Bureau of Transportation Statistics 
- Attributes: Year, month, day, day of the week, airline id, tail number, flight number, origin, origin city, dest, dest city, expected departure time, departure time, departure delay, arrival delay, cancelled (bool), carrier delay (bool), weather delay (bool)

## Data Set #2
PASSENGER DATA

- For 2018
- Source: Bureau of Transportation Statistics 
- Attributes: seats, passengers, unique_carrier, origin, origin_city, origin_state, dest, dest_city, dest_state, aircraft_type, class (only passenger)

## Data Set #3
REVIEWS DATA

- For 2018
- Source: 
- Attributes: airport_name, link, title, author, author_country, date, content, experience_airport, date_visit, type_traveller, overall_rating, queing_rating, terminal_cleanliness_rating, terminal_seating_rating, food_beverages_rating, airport_shopping_rating, wifi_connectivity_rating, airport_staff_rating, recommended 

## Data Set #4 
SENTIMENT DATA

- First compiled a list of the top 2,000 words across all airport reviews 
- Scraped 10 synonyms for each word in the top 2,000 words from thesaurus.com
- Attributes: word, synonym1, synonym2, synonym3, synonym4, synonym5, synonym6, synonym7, synonym8, synonym9, synonym10

## Data Set #5
AIRLINE LOGO DATA

- First compiled the airlines that fly out of IAH 
- Scraped the airline logos from travelpayouts.com
- Attributes: airline logo image

## Data Preparation 

- Dropped rows that contained NA values for important attributes
- Filtered data to ensure origin was IAH 
- Grouped and counted data across many attributes

## Exploratory Data Analysis
OVERVIEW

- Explored flight data for top destinations, number of flights, and number of passengers
- Explored airplane capacity in order to detect inefficiencies
- Explored distribution of airport ratings
- Explored word breakdowns of the airport reviews

## NEED TO UPDATE GRAPHS BASED OFF ALEX's FEEDBACK

## Top 20 Airport Destinations by Location
```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}
res <- dbSendQuery(conn = dcon, "
SELECT ORIGIN, count(*) as c
FROM flights
GROUP BY ORIGIN 
ORDER BY c DESC")
topOutgoing <- dbFetch(res, -1)
txairports <- c("ABI", "AUS", "CRP", "DFW", "DAL", "ELP", "GRK", "IAH", "HOU", "LBB", "MAF", "SAT", "ACT", "SPS")
topOutTexas <- topOutgoing$ORIGIN[topOutgoing$ORIGIN %in% txairports]
top4Texas <- topOutTexas[1:4]
dbClearResult(res)
res <- dbSendQuery(conn = dcon, "
SELECT *
FROM flights
WHERE ORIGIN = 'IAH';")
iahFlights <- dbFetch(res, -1)
dbClearResult(res)

res <- dbSendQuery(conn = dcon, "
SELECT *
FROM flights
WHERE ORIGIN = 'AUS';")
ausflights <- dbFetch(res, -1)
dbClearResult(res)

res <- dbSendQuery(conn = dcon, "
SELECT *
FROM flights
WHERE ORIGIN = 'DFW';")
dfwFlights <- dbFetch(res, -1)
dbClearResult(res)

res <- dbSendQuery(conn = dcon, "
SELECT *
FROM flights
WHERE ORIGIN = 'DAL';")
dalFlights <- dbFetch(res, -1)
dbClearResult(res)

# IAH
n <- length(sort(table(iahFlights$DEST)))
top20 <- data.frame(sort(table(iahFlights$DEST))[(n -20):n]) 
top20names <- as.vector(top20$Var1)
top20data <- iahFlights[iahFlights$DEST %in% top20names, ]
p1 <- ggplot() + 
  geom_bar(data=top20data, aes(DEST), color="black", fill="lightblue") + 
  theme(axis.text.x=element_text(angle=90, hjust=1, size=9)) +
  ylab("Number of Flights") + 
  xlab("Destination") +
  ggtitle("Top 20 Destinations from IAH")

# AUS
n <- length(sort(table(ausflights$DEST)))
top20 <- data.frame(sort(table(ausflights$DEST))[(n -20):n]) 
top20names <- as.vector(top20$Var1)
top20data <- ausflights[ausflights$DEST %in% top20names, ]
p2 <- ggplot() + 
  geom_bar(data=top20data, aes(DEST), color="black", fill="pink") + 
  theme(axis.text.x=element_text(angle=90, hjust=1, size=9)) +
  ylab("Number of Flights") + 
  xlab("Destination") +
  ggtitle("Top 20 Destinations from AUS")

# DFW
n <- length(sort(table(dfwFlights$DEST)))
top20 <- data.frame(sort(table(dfwFlights$DEST))[(n -20):n]) 
top20names <- as.vector(top20$Var1)
top20data <- dfwFlights[dfwFlights$DEST %in% top20names, ]
p3 <- ggplot() + 
  geom_bar(data=top20data, aes(DEST), color="black", fill="lightgreen") + 
  theme(axis.text.x=element_text(angle=90, hjust=1, size=9)) +
  ylab("Number of Flights") + 
  xlab("Destination") +
  ggtitle("Top 20 Destinations from DFW")

# DAL
n <- length(sort(table(dalFlights$DEST)))
top20 <- data.frame(sort(table(dalFlights$DEST))[(n -20):n]) 
top20names <- as.vector(top20$Var1)
top20data <- dalFlights[dalFlights$DEST %in% top20names, ]
p4 <- ggplot() + 
  geom_bar(data=top20data, aes(DEST), color="black", fill="purple") + 
  theme(axis.text.x=element_text(angle=90, hjust=1, size=9)) +
  ylab("Number of Flights") + 
  xlab("Destination") +
  ggtitle("Top 20 Destinations from DAL")

grid.arrange(p1, p2, p3, p4, nrow = 2)
```

## IAH Flight and Passenger Data in 2018
```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}
top10names <- c("ATL", "CLT", "DEN", "DFW", "DTW", "EWR", "LGA", "MSP", "ORD", "SFO")

# Count number of ppl that go to each airport from IAH 
res <- dbSendQuery(conn = dcon, "
SELECT DEST as dest, MONTH as month, SUM(PASSENGERS) as passenger_count
FROM passengers
WHERE ORIGIN = 'IAH'
GROUP BY DEST, MONTH;")
iahPassengers_total <- dbFetch(res, -1)
iahPassengers = iahPassengers_total[iahPassengers_total$dest %in% top10names,]
dbClearResult(res)

# Get count of number of flights out of IAH to each DEST
res <- dbSendQuery(conn = dcon, "
SELECT DEST as dest, MONTH as month, COUNT(*) as flight_count, DISTANCE as distance
FROM (SELECT DISTINCT YEAR, MONTH, DAY_OF_MONTH, DAY_OF_WEEK, TAIL_NUM, ORIGIN, DEST, DEP_TIME, DISTANCE
FROM flights)
WHERE ORIGIN = 'IAH' and YEAR = 2018
GROUP BY DEST, MONTH;")
iahFlightCount <- dbFetch(res, -1)
dbClearResult(res)
top10FlightCount = iahFlightCount[iahFlightCount$dest %in% top10names,]

# Get average rating from passengers
res <- dbSendQuery(conn = dcon, "
SELECT airport_code as dest, airport_name, AVG(overall_rating) as average_rating, AVG(clipped_sentiment) as review_rating
FROM sentiment
GROUP BY airport_name;")
raw_reviews <- dbFetch(res, -1)
dbClearResult(res)
reviews = raw_reviews[raw_reviews$dest %in% top10names,]

join1 = merge(iahPassengers, top10FlightCount, by=c("dest", "month"))
alldata = data.frame(merge(join1, reviews, by="dest"))

# Data preparation for graphing 

# Get the max per month 
max_passengers = data.frame(alldata %>% group_by(month) %>% summarise(max = max(passenger_count)))
max_flights = data.frame(alldata %>% group_by(month) %>% summarise(max = max(flight_count)))

regularized_passengers = c() 
regularized_flights = c()

for (row in 1:nrow(alldata)) {
    max_flight_count = max_flights[max_flights$month == 2,]$max
    new_flight_count = alldata[row, "flight_count"] / (max_flight_count)
    regularized_flights = c(regularized_flights, new_flight_count * 3)
    
    max_passenger_count = max_passengers[max_passengers$month == 2,]$max
    new_passenger_count = alldata[row, "passenger_count"] / (max_passenger_count*15)
    regularized_passengers = c(regularized_passengers, new_passenger_count)
}

alldata$passenger_count_regularized = regularized_passengers
alldata$flight_count_regularized = regularized_flights

# Join all the data together 
total_flights = as.data.frame(alldata %>% 
  group_by(month) %>% 
  summarise(Flights = sum(flight_count)))

total_flights$month <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")
total_flights$month <- fct_relevel(total_flights$month, "Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

num_flights <- ggplot(data = total_flights) + 
  aes(x=total_flights$month, y=total_flights$Flights, group = 1) + 
  geom_line(stat="identity", col = "royalblue1", lwd = 2) +
  geom_point(col = "royalblue1", size = 3) +
  ggtitle("Number of Flights Per Month Out of IAH") + 
  xlab("Month") + 
  ylab("Number of Flights")

# Join all the data together 
total_passengers = as.data.frame(alldata %>% 
  group_by(month) %>% 
  summarise(Passengers = sum(passenger_count)))

total_passengers$month <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")
total_passengers$month <- fct_relevel(total_passengers$month, "Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

num_pass <- ggplot(data = total_passengers) + 
  aes(x=month, y=Passengers, group = 1) + 
  geom_line(stat="identity", col = "royalblue1", lwd = 2) + 
  geom_point(col = "royalblue1", size = 3) +
  ggtitle("Number of Passengers Per Month Out of IAH") + 
  xlab("Month") + 
  ylab("Number of Passengers")

grid.arrange(num_flights, num_pass, nrow = 2)

```

## Inefficiency of Flights Out of IAH
```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}
DT = data.frame(
  month = c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"),
  Ineffeciency = c(1795726, 1790006, 795726, 1327422, 1299193, 1086968, 1291711, 1650673, 1733035, 1499018, 1352993, 1459601))

DT$month <- fct_relevel(DT$month, "Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")
usingGg <- ggplot(data=DT, aes(x=DT$month, y=DT$Ineffeciency, group=1)) +
  geom_line(col = "indianred1", lwd = 2)+
  geom_point(col = "indianred1", size = 3) + labs(title = "Empty Seats per Month from IAH", x= "Month", y = "Number of Empty Seats")
usingGg
```

## Distribution of Airport Ratings

```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}

```

## Most Common Words in Airport Reviews
```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}
cbPalette <- c("chocolate", "cornflowerblue", "brown4", "blueviolet", "blue", "black", "aquamarine4", "dodgerblue1", "dimgrey", "deeppink4", "darkviolet", "darkslateblue", "darksalmon", "darkred", "darkorchid1", "darkolivegreen4", "cyan2", "green4", "indianred3", "mediumblue", "hotpink1", "paleturquoise2", "orangered4", "navyblue", "red")
res <- dbSendQuery(conn = dcon, "
SELECT *
FROM top2kdf;")
top2kdf <- dbFetch(res, -1)
dbClearResult(res)
all_words = as.vector(t(top2kdf))
word_table = table(all_words)
word_table = sort(word_table, decreasing=TRUE)
word_df = data.frame(word_table[2:26])
ggplot(data = word_df, aes(x=all_words, y=Freq)) + 
  geom_bar(stat="identity", fill= cbPalette) +
  labs(x="Word", y="Count", title="Top 25 Word Counts") +
  theme(axis.text.x=element_text(angle=90, hjust=1, size=12))
```

## Sentiment Analysis

- Conducted sentiment analysis on the airport reviews
- Used synonyms we scraped from thesaurus.com for our sentiment data set in order to condense the reviews
- Used RSentiment package on these condensed reviews in order to determine if a review had a positive, neutral, or negative sentiment
- Compared our sentiment score to the average rating of the aiport to analyze effectiveness of sentiment analysis

## Analyzing the Effectivness of Sentiment Analysis
```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}
res <- dbSendQuery(conn = dcon, "
SELECT airport_name as Airport, sum(match) as NumMatches, count(match) as TotalReviews
FROM sentiment
GROUP BY title;")
matches_by_airport <- dbFetch(res, -1)
dbClearResult(res)

texas_airports <- matches_by_airport[matches_by_airport$Airport == "austin-airport" | matches_by_airport$Airport == "dallas-fort-worth-airport" | matches_by_airport$Airport == "dallas-love-field-airport" | matches_by_airport$Airport == "houston-george-bush-intercontinental-airport" | matches_by_airport$Airport == "houston-hobby-airport" | matches_by_airport$Airport == "el-paso-airport" ,]

value <- texas_airports$TotalReviews
airport <- c(rep("AUS", texas_airports[1,3]), rep("DFW", texas_airports[2,3]), rep("DAL", texas_airports[3,3]),
             rep("ELP", texas_airports[4,3]), rep("IAH", texas_airports[5,3]), rep("HOU", texas_airports[6,3]))
Result <- c(rep("Success",5), rep("Failure",3), rep("Success",9), rep("Failure",40),
            rep("Failure",3), rep("Success",1), rep("Failure",2), rep("Success",28), rep("Failure",69),
            rep("Success",2), rep("Failure",2))
data <- data.frame(airport,Result)

ggplot(data, aes(fill=Result, x=airport)) + 
  geom_bar(position="fill") + 
  xlab("Texas Airports") + 
  ylab("Percentage of Reviews") + 
  ggtitle("Accuracy for Sentiment Analysis Across Texas Airport Data") + scale_fill_manual(values = c("red", "darkgreen"))
```

## Time Series Modeling
```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}

```

## Killer Plot #1

```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}
plot_nodes <- function(radius, rating, X, Y, sentiment, idx) {
  for (idx in 1:10){ 
    # Cutoff threshold is 5 because ratings can range from 1 to 10 
    fillColor = ifelse(rating[idx] > 5.0, "green", "red")
    # Cutoff threshold is 0.0 because ratings can range from -1 to 1 
    outlineColor = ifelse(sentiment[idx] > 0.0, "green", "red") 
    grid.circle(x = unit(X[idx], "npc"), y = unit(Y[idx], "npc"), r = unit(radius[idx], "npc"),
                gp = gpar(fill = fillColor, col = outlineColor, lwd = 3))
  }
}

label_nodes <- function(labels, X, Y) {
  for (i in 1:10){
    grid.text(labels[i], x = unit(X[i], "npc"), y = unit(Y[i], "npc"), gp = gpar(fontsize = 7))
  }
}

plot_luggage <- function() {
  grid.rect(x = unit(0.5, "npc"), y = unit(0.40, "npc"), width = unit(0.80, "npc"), 
            height = unit(0.70, "npc"), gp = gpar(lwd = 4))
  grid.lines(x = unit(c(0.25, 0.25), "npc"),y = unit(c(0.75, 0.92), "npc"), gp = gpar(lwd = 4))
  grid.lines(x = unit(c(0.75, 0.75), "npc"),y = unit(c(0.75, 0.92), "npc"), gp = gpar(lwd = 4))
  grid.lines(x = unit(c(0.25, 0.75), "npc"),y = unit(c(0.92, 0.92), "npc"), gp = gpar(lwd = 4))
  grid.lines(x = unit(c(0.30, 0.30), "npc"),y = unit(c(0.75, 0.85), "npc"), gp = gpar(lwd = 4))
  grid.lines(x = unit(c(0.70, 0.70), "npc"),y = unit(c(0.75, 0.85), "npc"), gp = gpar(lwd = 4))
  grid.lines(x = unit(c(0.30, 0.70), "npc"),y = unit(c(0.85, 0.85), "npc"), gp = gpar(lwd = 4))
  grid.text("Top 10 Airport Destinations from IAH 2018 Analysis", x = unit(0.50, "npc"), 
            y = unit(0.885, "npc"),gp = gpar(fontsize = 9, fontface = 'bold'))
}

plot_legend <- function() {
  grid.lines(x = unit(c(0.70, 0.85), "npc"), y = unit(c(0.80, 0.70), "npc"), gp = gpar(lwd = 4))
  grid.rect(x = unit(0.83, "npc"), y = unit(0.60, "npc"), width = unit(0.305, "npc"), 
            height = unit(0.26, "npc"), gp = gpar(lwd = 4))
  grid.text("Legend:", x = unit(0.73, "npc"), y = unit(0.71, "npc"), 
            gp = gpar(fontsize = 10, fontface = 'bold'))
  grid.text("Size of Node = Passengers per month", x = unit(0.695, "npc"), 
            y = unit(0.68, "npc"),gp = gpar(fontsize = 8), just = "left")
  grid.text("Red Node = Low rated airport", x = unit(0.695, "npc"), 
            y = unit(0.65, "npc"),gp = gpar(fontsize = 8), just = "left")
  grid.text("Green Node = High rated airport", x = unit(0.695, "npc"), 
            y = unit(0.62, "npc"),gp = gpar(fontsize = 8), just = "left")
  grid.text("Red Border = Negative airport reviews", x = unit(0.695, "npc"), 
            y = unit(0.59, "npc"),gp = gpar(fontsize = 8), just = "left")
  grid.text("Green Border = Positive airport reviews", x = unit(0.695, "npc"), 
            y = unit(0.56, "npc"),gp = gpar(fontsize = 8), just = "left")
  grid.text("Edge Length = Distance to Airport", x = unit(0.695, "npc"), 
            y = unit(0.53, "npc"),gp = gpar(fontsize = 8), just = "left")
  grid.text("Width of Edge = Flights per month", x = unit(0.695, "npc"), 
            y = unit(0.50, "npc"),gp = gpar(fontsize = 8), just = "left")
}

plot_edges <- function(U, V, weights) {
  for (i in 1:10){
    # change lwd, max 7 
    grid.lines(x = unit(c(0.4, U[i]), "npc"), y = unit(c(0.12, V[i]), "npc"), gp = gpar(lwd = weights[i]))
  }
}

my.grid.plot <- function(data, month){
  grid.newpage()
  grid.layout(1,2)
  top.vp <- viewport(width = 1.0, height = 1.0)
  pushViewport(top.vp)
  
  plot_luggage()
  plot_legend()
  
  # Create IAH Node 
  grid.circle(x = unit(0.4, "npc"), y = unit(0.12, "npc"), r = unit(0.03, "npc"), gp = gpar(fill = "black"))
  grid.text("IAH", x=unit(0.4, "npc"), y=unit(0.075, "npc"), gp=gpar(fontsize=8))
  
  # Create Edges 
  #     689,  912   862   224   1075  1400  1416  1034  925   1635
  X = c(0.18, 0.20, 0.33, 0.30, 0.43, 0.53, 0.63, 0.68, 0.63, 0.75)
  Y = c(0.38, 0.53, 0.45, 0.13, 0.55, 0.66, 0.61, 0.43, 0.23, 0.15)
  weights = data[data$month == month,]$flight_count_regularized
  plot_edges(X, Y, weights) 
  
  # Create Nodes 
  radius = data[data$month == month,]$passenger_count_regularized
  rating = data$average_rating 
  sentiment = data$review_rating
  labels = c("ATL", "CLT", "DEN", "DFW", "DTW", "EWR", "LGA", "MSP", "ORD", "SFO")  
  labels_X = c(0.18, 0.20, 0.33,  0.22,  0.43,  0.54,  0.63,  0.68,  0.705,  0.81)
  labels_Y = c(0.46, 0.60, 0.56,  0.13,  0.61,  0.58,  0.55,  0.38,  0.23,  0.15)
  plot_nodes(radius, rating, X, Y, sentiment)
  label_nodes(labels, labels_X, labels_Y)
}

# Define UI for application that draws a histogram
ui <- fluidPage(
   # Application title
   titlePanel("Top 10 Airport Destinations from IAH 2018 Analysis"),
   # Sidebar with a slider input for number of bins 
    sidebarPanel(
      radioButtons("month",
                   label = "Select Month:",
                   choices = list("January"=1,"February"=2,"March"=3,
                                  "April"=4, "May"=5, "June"=6, 
                                  "July"=7, "August"=8, "September"=9, 
                                  "October"=10, "November"=11, "December"=12),
                   selected = 1)
    ),
      # Show a plot of the generated distribution
      mainPanel(
         plotOutput("killerPlot", width="510px", height="400px")
      )
   )

# Define server logic required to draw a histogram
server <- function(input, output) {
  output$killerPlot <- renderPlot({
    # generate killer plot based on input$month from ui.R
    my.grid.plot(alldata, input$month)
  })
}

# Run the application 
shinyApp(ui = ui, server = server)
```

## Killer Plot #2

```{r, echo=FALSE, message = FALSE, error = FALSE, warning=FALSE}

```


## Conclusion 
IMPORTANCE OF FINDINGS

- need things here...

TAKEAWAYS
- Sentiment analysis on airport reviews not an effective way to determine quality of an airport
_ need stuff here...

## {.flexbox .vcenter}
<div class="centered">
  <font size="8">Thanks!</font> 
  
  Any questions? 
</div>

